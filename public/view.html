<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ver Tela • Suporte X</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="card">
    <h1>Técnico: Ver Tela</h1>
    <div class="row">
      <input id="room" type="text" placeholder="Código da sessão (6 dígitos)" />
      <button id="join">Entrar</button>
    </div>
    <p class="muted">Dica: se recebeu um link com <code>?room=123456</code>, o código já será preenchido automaticamente.</p>
    <video id="video" autoplay playsinline></video>
    <p class="muted" id="status">Aguardando…</p>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="/common.js"></script>
    <script>
      const roomInput = qs('#room');
      const joinBtn = qs('#join');
      const statusEl = qs('#status');
      const video = qs('#video');

      const roomFromURL = getRoomFromQuery();
      if (roomFromURL) {
        roomInput.value = roomFromURL;
      }

      let pc, socket;

      function iceServers(){
        const s = [{ urls: 'stun:stun.l.google.com:19302' }];
        // Opcional: adicione TURN aqui depois (urls, username, credential)
        return s;
      }

      function setStatus(msg){ statusEl.textContent = msg; }

      joinBtn.onclick = async () => {
        const room = roomInput.value.trim();
        if (!room) { alert('Informe o código da sessão'); return; }
        joinBtn.disabled = true;

        socket = io();
        socket.emit('join', room);

        pc = new RTCPeerConnection({ iceServers: iceServers() });
        pc.ontrack = (e) => { video.srcObject = e.streams[0]; setStatus('Recebendo vídeo…'); };
        pc.onicecandidate = e => { if (e.candidate) socket.emit('signal', { room, data: e.candidate }); };

        socket.on('signal', async (data) => {
          if (data.type === 'offer') {
            await pc.setRemoteDescription(data);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('signal', { room, data: answer });
            setStatus('Conectado!');
          } else if (data.candidate) {
            try { await pc.addIceCandidate(data); } catch (e){ console.error(e); }
          }
        });

        socket.on('peer-left', () => setStatus('Cliente encerrou o compartilhamento.'));
      };
    </script>
  </div>
  <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(() => console.log('Service Worker registrado!'))
    .catch(err => console.error('Erro ao registrar SW:', err));
}
</script>
</body>
</html>
